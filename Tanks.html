<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Танковый Прорыв: Тактическая Битва</title>
    <style>
        body { margin: 0; background: #d2c19a; overflow: hidden; font-family: 'Arial Black', sans-serif; }
        canvas { background: #e0e0e0; display: block; }
        #ui { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 5px; border-left: 5px solid #3498db; pointer-events: none; z-index: 10; }
        .hp-bar { width: 200px; height: 12px; background: #aaa; border: 1px solid #555; margin: 5px 0; }
        #hp-fill { background: #2ecc71; height: 100%; width: 100%; transition: 0.2s; }
        #p-hp-fill { background: #3498db; height: 100%; width: 100%; transition: 0.2s; }
        #boss-ui { position: absolute; top: 20px; width: 100%; text-align: center; display: none; }
        .boss-hp-bar { width: 500px; height: 20px; background: #444; border: 2px solid #e74c3c; margin: 5px auto; }
        #boss-hp-fill { background: #e74c3c; height: 100%; width: 100%; }
        #radar { position: absolute; bottom: 20px; right: 20px; width: 180px; height: 180px; background: rgba(255, 255, 255, 0.9); border: 2px solid #555; border-radius: 5px; }
        #victory-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; color: gold; z-index: 100; }
    </style>
</head>
<body>

<div id="victory-screen">
    <h1 style="font-size: 60px;">МИССИЯ ВЫПОЛНЕНА</h1>
    <button onclick="location.reload()" style="padding: 15px 30px; font-size: 20px; cursor: pointer;">ВЕРНУТЬСЯ В ШТАБ</button>
</div>

<div id="ui">
    ШТАБ HP: <div class="hp-bar"><div id="hp-fill"></div></div>
    БРОНЯ ТАНКА: <div class="hp-bar"><div id="p-hp-fill"></div></div>
    ФЛАГИ: <span id="flags" style="color:#d4af37">0 / 3</span><br>
    <small id="ally-status" style="color: #2980b9;">ПОМОЩНИК: ОЖИДАНИЕ</small>
</div>

<div id="boss-ui"><div class="boss-hp-bar"><div id="boss-hp-fill"></div></div></div>
<canvas id="radar" width="180" height="180"></canvas>
<canvas id="game"></canvas>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type, duration, vol=0.1) {
    try {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    } catch(e){}
}

const canvas = document.getElementById('game'); const ctx = canvas.getContext('2d');
const radarCtx = document.getElementById('radar').getContext('2d');
const WORLD_SIZE = 2500;
let VW, VH, shake = 0, gameWon = false;
function resize() { VW = canvas.width = window.innerWidth; VH = canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

let baseHp = 100, playerHp = 100, captured = 0, boss = null, isAlarm = false;
const keys = {}, bullets = [], enemies = [], walls = [], medkits = [], upgrades = [];
let allyTank = null;

for(let i=0; i<25; i++) walls.push({ x: 400 + Math.random()*1700, y: 400 + Math.random()*1200, w: 160, h: 160 });

const player = { x: WORLD_SIZE/2, y: WORLD_SIZE-300, angle: -Math.PI/2, speed: 5.5, color: '#2980b9', r: 30, lastShot: 0 };
const base = { x: WORLD_SIZE/2 - 150, y: WORLD_SIZE - 200, w: 300, h: 150 };
const flags = [ {x: 500, y: 400, a: 1}, {x: WORLD_SIZE/2, y: 400, a: 1}, {x: WORLD_SIZE-500, y: 400, a: 1} ];

function isColliding(x, y, r) {
    if (x < r || x > WORLD_SIZE-r || y < r || y > WORLD_SIZE-r) return true;
    for (let w of walls) if (x + r > w.x && x - r < w.x + w.w && y + r > w.y && y - r < w.y + w.h) return true;
    return false;
}

function spawnEnemy(type, isHunter = false) {
    let x = Math.random()*WORLD_SIZE, y = Math.random()*400;
    if(type === 'SCOUT') { x = 700 + Math.random()*1100; y = 700 + Math.random()*1100; }
    enemies.push({ 
        x, y, type, isHunter, color: type==='SCOUT'?'#8e44ad':type==='ATTACKER'?'#c0392b':'#f39c12',
        speed: type==='SCOUT'?3.6:1.8, r: 24, fireRate: 1500, angle: 1.5, lastShot: 0, 
        avoidAngle: 0 // Для логики обхода стен
    });
}

for(let i=0; i<3; i++) spawnEnemy('SCOUT');
for(let i=0; i<8; i++) spawnEnemy('ATTACKER');

window.onkeydown = e => keys[e.code] = true; window.onkeyup = e => keys[e.code] = false;
window.addEventListener('click', () => { if(audioCtx.state === 'suspended') audioCtx.resume(); });

function drawTank(t, color, isBoss = false) {
    ctx.save(); ctx.translate(t.x, t.y); ctx.rotate(t.angle);
    ctx.fillStyle = "#222"; ctx.fillRect(-t.r, -t.r*0.8, t.r*2, t.r*0.35); ctx.fillRect(-t.r, t.r*0.5, t.r*2, t.r*0.35);
    ctx.fillStyle = color; ctx.fillRect(-t.r*0.8, -t.r*0.6, t.r*1.6, t.r*1.2);
    ctx.beginPath(); ctx.arc(0, 0, t.r*0.55, 0, 7); ctx.fill(); ctx.stroke();
    ctx.fillStyle = "#111"; ctx.fillRect(0, -4, t.r*1.5, 8);
    if(isBoss) { ctx.fillRect(10, -22, t.r*1.3, 10); ctx.fillRect(10, 12, t.r*1.3, 10); }
    ctx.restore();
}

function update() {
    if(gameWon) return;
    let nx = player.x, ny = player.y;
    if (keys['ArrowLeft'] || keys['KeyA']) player.angle -= 0.05;
    if (keys['ArrowRight'] || keys['KeyD']) player.angle += 0.05;
    if (keys['ArrowUp'] || keys['KeyW']) { nx += Math.cos(player.angle)*player.speed; ny += Math.sin(player.angle)*player.speed; }
    if (keys['ArrowDown'] || keys['KeyS']) { nx -= Math.cos(player.angle)*player.speed; ny -= Math.sin(player.angle)*player.speed; }
    if(!isColliding(nx, player.y, player.r)) player.x = nx;
    if(!isColliding(player.x, ny, player.r)) player.y = ny;

    if (keys['Space'] && Date.now() - player.lastShot > 350) {
        bullets.push({ x: player.x, y: player.y, vx: Math.cos(player.angle)*16, vy: Math.sin(player.angle)*16, owner: 'p', p: 15 });
        player.lastShot = Date.now(); shake = 8; playSound(150, 'sawtooth', 0.1);
    }

    if(captured === 3 && !boss) {
        boss = { x: WORLD_SIZE/2, y: 100, angle: Math.PI/2, r: 85, hp: 1300, maxHp: 1300, speed: 1.3, lastShot: 0 };
        enemies.length = 0; document.getElementById('boss-ui').style.display = 'block';
    }

    if(!boss && !allyTank && Math.random() < 0.003 && upgrades.length < 1) upgrades.push({ x: 1000 + Math.random()*500, y: 1800 + Math.random()*300 });

    // ПОМОЩНИК (ИСПРАВЛЕН)
    if(allyTank) {
        let targetEn = null, minDist = 1200; // Увеличен радиус обзора
        enemies.forEach(en => {
            let d = Math.hypot(en.x-allyTank.x, en.y-allyTank.y);
            if(d < minDist) { minDist = d; targetEn = en; }
        });
        if(!targetEn && boss) targetEn = boss;
        
        if(targetEn) {
            allyTank.angle = Math.atan2(targetEn.y-allyTank.y, targetEn.x-allyTank.x);
            if(Date.now()-allyTank.lastShot > 700) {
                bullets.push({ x: allyTank.x, y: allyTank.y, vx: Math.cos(allyTank.angle)*14, vy: Math.sin(allyTank.angle)*14, owner: 'p', p: 12 });
                allyTank.lastShot = Date.now(); playSound(180, 'sawtooth', 0.1);
            }
        }
    }

    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        if (isColliding(b.x, b.y, 5)) bullets.splice(i, 1);
        else if (b.owner === 'p') {
            if(boss && Math.hypot(b.x-boss.x, b.y-boss.y) < boss.r) { boss.hp -= 30; bullets.splice(i, 1); }
            enemies.forEach((en, ei) => {
                if (Math.hypot(b.x-en.x, b.y-en.y) < en.r) {
                    if(Math.random() < 0.4) medkits.push({x: en.x, y: en.y});
                    enemies.splice(ei, 1); spawnEnemy(en.type); bullets.splice(i, 1); playSound(80, 'sawtooth', 0.3);
                }
            });
        } else {
            // УРОН ВРАГОВ УВЕЛИЧЕН
            if (Math.hypot(b.x-player.x, b.y-player.y) < player.r) { playerHp -= 12; bullets.splice(i,1); }
            if (Math.hypot(b.x-(base.x+150), b.y-(base.y+75)) < 150) { baseHp -= 1.5; bullets.splice(i,1); }
        }
    });

    let scoutFound = false;
    enemies.forEach(en => {
        let dP = Math.hypot(en.x-player.x, en.y-player.y);
        if (en.type === 'SCOUT' && dP < 500) {
            if(!isAlarm) { isAlarm = true; let c=0; enemies.forEach(e=>{if(e.type==='ATTACKER'&&c<3){e.isHunter=true; c++;}}); }
            scoutFound = true;
        }

        let tx = (en.isHunter || (isAlarm && en.type==='SCOUT')) ? player.x : base.x+150;
        let ty = (en.isHunter || (isAlarm && en.type==='SCOUT')) ? player.y : base.y+75;
        if(en.type==='SCOUT' && !isAlarm) { tx = en.tx; ty = en.ty; }

        let targetAngle = Math.atan2(ty-en.y, tx-en.x);
        
        // НОВАЯ ЛОГИКА ОБХОДА СТЕН (ИСПРАВЛЕННОЕ КРУЖЕНИЕ)
        let ex = en.x + Math.cos(en.angle) * en.speed;
        let ey = en.y + Math.sin(en.angle) * en.speed;

        if (!isColliding(ex, ey, en.r)) {
            // Плавный поворот к цели, если путь свободен
            let angleDiff = targetAngle - en.angle;
            while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
            while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
            en.angle += angleDiff * 0.05;
            en.x = ex; en.y = ey;
        } else {
            // Упираемся в стену - резко меняем вектор
            en.angle += 1.0;
        }

        if(dP < 600 && Date.now()-en.lastShot > en.fireRate) {
            bullets.push({x:en.x, y:en.y, vx:Math.cos(en.angle)*10, vy:Math.sin(en.angle)*10, owner:'e'});
            en.lastShot = Date.now();
        }
    });
    if(!scoutFound) isAlarm = false;

    upgrades.forEach((u, i) => {
        if(Math.hypot(player.x-u.x, player.y-u.y) < 60) {
            allyTank = { x: base.x+150, y: base.y-80, angle: -Math.PI/2, r: 28, lastShot: 0 };
            upgrades.splice(i, 1); playSound(400, 'sine', 0.5);
            document.getElementById('ally-status').innerText = "ПОМОЩНИК: ОБОРОНА";
        }
    });

    if(boss) {
        let bTx = (boss.hp<900)?player.x:base.x+150;
        let bTy = (boss.hp<900)?player.y:base.y+75;
        boss.angle = Math.atan2(bTy-boss.y, bTx-boss.x);
        boss.x += Math.cos(boss.angle)*boss.speed; boss.y += Math.sin(boss.angle)*boss.speed;
        if(Date.now()-boss.lastShot > 1000) {
            for(let a of [-0.2, 0, 0.2]) bullets.push({x:boss.x, y:boss.y, vx:Math.cos(boss.angle+a)*11, vy:Math.sin(boss.angle+a)*11, owner:'e'});
            boss.lastShot = Date.now();
        }
        if(boss.hp <= 0) { gameWon = true; document.getElementById('victory-screen').style.display = 'flex'; }
        document.getElementById('boss-hp-fill').style.width = (boss.hp/boss.maxHp)*100 + "%";
    }

    flags.forEach(f => { if(f.a && Math.hypot(player.x-f.x, player.y-f.y) < 80) { f.a = 0; captured++; playSound(600, 'sine', 0.3); } });
    medkits.forEach((m, i) => { if (Math.hypot(player.x-m.x, player.y-m.y) < 60) { playerHp = Math.min(100, playerHp+45); baseHp = Math.min(100, baseHp+20); medkits.splice(i, 1); playSound(800, 'sine', 0.2); }});
    
    document.getElementById('hp-fill').style.width = baseHp + "%";
    document.getElementById('p-hp-fill').style.width = playerHp + "%";
    document.getElementById('flags').innerText = `${captured} / 3`;
    if (baseHp <= 0 || playerHp <= 0) { alert("ГОРОД ПАЛ. ПОРАЖЕНИЕ."); location.reload(); }
    if(shake > 0) shake *= 0.9;
}

function draw() {
    ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,VW,VH);
    let sx = (Math.random()-0.5)*shake, sy = (Math.random()-0.5)*shake;
    ctx.translate(-player.x + VW/2 + sx, -player.y + VH/2 + sy);
    ctx.fillStyle = "#d2c19a"; ctx.fillRect(0,0,WORLD_SIZE,WORLD_SIZE);
    walls.forEach(w => { ctx.fillStyle = "#c0c0c0"; ctx.fillRect(w.x-10, w.y-10, w.w+20, w.h+20); ctx.fillStyle = "#707070"; ctx.fillRect(w.x, w.y, w.w, w.h); });
    ctx.fillStyle = "#2e4d2e"; ctx.fillRect(base.x, base.y, base.w, base.h);
    flags.forEach(f => { if(f.a) { ctx.fillStyle = "#f1c40f"; ctx.fillRect(f.x, f.y-40, 30, 20); ctx.fillStyle = "#fff"; ctx.fillRect(f.x, f.y-40, 4, 60); } });
    medkits.forEach(m => { ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(m.x, m.y, 18, 0, 7); ctx.fill(); ctx.fillStyle = "red"; ctx.fillRect(m.x-10, m.y-2, 20, 4); ctx.fillRect(m.x-2, m.y-10, 4, 20); });
    upgrades.forEach(u => { ctx.fillStyle = "#3498db"; ctx.beginPath(); ctx.arc(u.x, u.y, 22, 0, 7); ctx.fill(); ctx.fillStyle="white"; ctx.font="bold 25px Arial"; ctx.fillText("+", u.x-8, u.y+10); });
    bullets.forEach(b => { ctx.fillStyle = b.owner==='p'?"#00bfff":"#ff4500"; ctx.beginPath(); ctx.arc(b.x, b.y, 6, 0, 7); ctx.fill(); });
    enemies.forEach(en => drawTank(en, en.color));
    if(allyTank) drawTank(allyTank, "#3498db");
    if(boss) drawTank(boss, "#444", true);
    drawTank(player, player.color);

    radarCtx.clearRect(0,0,180,180); const s = 180/WORLD_SIZE;
    radarCtx.fillStyle = "#2ecc71"; radarCtx.fillRect(base.x*s, base.y*s, base.w*s, base.h*s);
    flags.forEach(f => { if(f.a) { radarCtx.fillStyle = "gold"; radarCtx.fillRect(f.x*s, f.y*s, 6, 6); } });
    upgrades.forEach(u => { radarCtx.fillStyle = "#00bfff"; radarCtx.fillRect(u.x*s, u.y*s, 5, 5); });
    enemies.forEach(en => { radarCtx.fillStyle = en.isHunter?"red":en.color; radarCtx.beginPath(); radarCtx.arc(en.x*s, en.y*s, 2, 0, 7); radarCtx.fill(); });
    radarCtx.fillStyle = "#3498db"; radarCtx.beginPath(); radarCtx.arc(player.x*s, player.y*s, 4, 0, 7); radarCtx.fill();
    requestAnimationFrame(update); requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>

